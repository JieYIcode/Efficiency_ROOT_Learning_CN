<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>高实用性代码收录: 程序调试</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Root6Icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">高实用性代码收录<span id="projectnumber">&#160;v0.1</span>
   </div>
   <div id="projectbrief">可读 实用 高效</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2_xE7_xA8_x8B_xE5_xBA_x8F_xE8_xB0_x83_xE8_xAF_x95_2_xE7_xA8_x8B_xE5_xBA_x8F_xE8_xB0_x83_xE8_xAF_x95.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">程序调试</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md7"></a></p>
<p>对于长时间运行的 SystemC 程序，建议使用以下工具来监测内存和性能：</p>
<ol type="1">
<li>Valgrind：<ul>
<li>使用 Valgrind 的 <code>memcheck</code> 工具可以检测内存泄漏和内存错误。它对代码运行性能有较大影响，适合在较小的数据集上进行初步测试，确保代码没有明显的内存问题。</li>
</ul>
</li>
<li>Perf：<ul>
<li>Perf 是一个强大的性能分析工具，可以用来监测 CPU 使用情况和性能瓶颈。可以通过 <code>perf record</code> 记录性能数据，然后用 <code>perf report</code> 来分析结果。它对性能的影响相对较小，适合长时间运行的程序。</li>
</ul>
</li>
<li>gprof：<ul>
<li>如果你编译时使用了 <code>-pg</code> 选项，可以通过 <code>gprof</code> 生成性能分析报告。这种方法对程序性能的影响也较小。</li>
</ul>
</li>
<li>top/htop：<ul>
<li>在运行时使用 <code>top</code> 或 <code>htop</code> 监控系统资源的使用情况。可以观察内存、CPU 使用情况，识别是否有异常。</li>
</ul>
</li>
<li>SystemTap：<ul>
<li>SystemTap 可以用来动态监测 Linux 内核和应用程序的性能。它对系统性能的影响较小，适合长期监测。</li>
</ul>
</li>
</ol>
<p>选择工具时，可以先在小规模的测试中确认是否存在内存问题或性能瓶颈，然后再决定在完整运行时使用哪个工具进行监测。</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Valgrind</h1>
<h2><a class="anchor" id="autotoc_md9"></a>
1. 安装 Valgrind（如果还未安装）：</h2>
<ul>
<li>在 Ubuntu 上，可以使用以下命令安装： <div class="fragment"><div class="line">sudo apt-get install valgrind</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md10"></a>
2. 编译你的程序：</h2>
<p>确保你的程序在调试模式下编译，以便 Valgrind 能够提供更有用的信息。如果是使用CMake 则设置： </p><div class="fragment"><div class="line">cmake -DCMAKE_BUILD_TYPE=Debug ..</div>
<div class="line">make</div>
</div><!-- fragment --><p>如果是使用GCC，可以加上<code>-g</code>选项：</p>
<div class="fragment"><div class="line">gcc -g -o my_program my_program.c</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
3. 运行 Valgrind：</h2>
<ul>
<li>使用 Valgrind 来运行你的可执行文件。假设你的可执行文件名为 <code>your_program</code>，可以这样运行： <div class="fragment"><div class="line">valgrind --leak-check=full --track-origins=yes ./your_program</div>
</div><!-- fragment --></li>
<li>这里的选项说明：<ul>
<li><code>--leak-check=full</code>：启用详细的内存泄漏检查。</li>
<li><code>--track-origins=yes</code>：显示未初始化变量的源头。</li>
</ul>
</li>
</ul>
<dl class="section important"><dt>Important</dt><dd><br  />
 如果要保存所有输出结果到txt文件，建议这样： <br  />
<br  />
 <div class="fragment"><div class="line">valgrind --leak-check=full --track-origins=yes ./your_program &gt; valgrind_output.txt 2&gt;&amp;1</div>
</div><!-- fragment --> <br  />
<br  />
<ul>
<li><code>&gt; valgrind_output.txt</code> 将标准输出（stdout）重定向到 <code>valgrind_output.txt</code> 文件中。</li>
<li><code>2&gt;&amp;1</code> 将标准错误（stderr）也重定向到同一个文件，这样你可以在同一个文件中查看所有输出，包括错误信息。 <br  />
<br  />
</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="autotoc_md12"></a>
4. 分析输出：</h2>
<ul>
<li>Valgrind 会输出运行期间的内存使用情况，包括任何检测到的内存泄漏和错误。你可以根据这些信息来修复代码中的问题。</li>
<li>如果发现问题，记下 Valgrind 的输出，定位问题后进行修复，然后再次编译和测试。</li>
<li>如果程序运行时间较长，可以考虑在某些阶段进行快照或分阶段运行 Valgrind，以便更好地跟踪和定位问题。</li>
</ul>
<h1><a class="anchor" id="autotoc_md13"></a>
Perf</h1>
<p>使用 <code>perf</code> 工具进行性能分析的基本步骤如下：</p>
<h2><a class="anchor" id="autotoc_md14"></a>
1. 安装 <code>perf</code></h2>
<p>在大多数Linux发行版上，<code>perf</code> 可以通过包管理器安装。例如，在Ubuntu上，你可以使用以下命令： </p><div class="fragment"><div class="line">sudo apt-get install linux-tools-common linux-tools-generic</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
2. 编译你的程序</h2>
<p>为了获得更准确的性能数据，建议在编译时启用调试信息。例如，如果你使用GCC，可以加上<code>-g</code>选项： </p><div class="fragment"><div class="line">gcc -g -o my_program my_program.c</div>
</div><!-- fragment --><p>如果是在 CMake 中则设置：</p>
<div class="fragment"><div class="line">cmake -DCMAKE_BUILD_TYPE=Debug ..</div>
<div class="line">make</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md16"></a>
autotoc_md16</h2>
<h2><a class="anchor" id="autotoc_md17"></a>
3. 收集性能数据</h2>
<p>使用 <code>perf</code> 运行你的程序。你可以使用以下命令： </p><div class="fragment"><div class="line">perf record -g ./my_program</div>
</div><!-- fragment --><p> 这里，<code>-g</code> 选项会启用调用图（call graph）记录，这样可以分析函数调用关系。</p>
<dl class="section attention"><dt>Attention</dt><dd><br  />
 如果报错 Error: Access to performance monitoring and observability operations is limited.或者WARNING: Kernel address maps (/proc/{kallsyms,modules}) are restricted，可以用临时解除权限限制的方式解决： <br  />
<br  />
 <div class="fragment"><div class="line">echo -1 | sudo tee /proc/sys/kernel/perf_event_paranoid</div>
<div class="line">echo 0 | sudo tee /proc/sys/kernel/kptr_restrict</div>
</div><!-- fragment --></dd></dl>
<h2><a class="anchor" id="autotoc_md18"></a>
4. 查看性能数据</h2>
<p>运行结束后，你可以使用以下命令查看性能分析结果： </p><div class="fragment"><div class="line">perf report</div>
</div><!-- fragment --><p> 这将显示程序执行期间的函数调用情况及其占用的CPU时间。</p>
<h2><a class="anchor" id="autotoc_md19"></a>
5. 生成图形化的调用图（Flamegraph工具包）</h2>
<p>如果需要更直观的调用图，可以使用以下命令： </p><div class="fragment"><div class="line">perf script | flamegraph/stackcollapse-perf.pl | flamegraph/flamegraph.pl &gt; out.svg</div>
</div><!-- fragment --><p> 这需要先安装Flamegraph工具包，可以在<a href="https://github.com/brendangregg/Flamegraph">Flamegraph GitHub</a>找到。</p>
<p>使用 Flamegraph 工具包进行性能分析通常包括以下步骤：</p>
<h3><a class="anchor" id="autotoc_md20"></a>
1. 安装 Flamegraph</h3>
<p>可以从 <a href="https://github.com/brendangregg/Flamegraph">Flamegraph GitHub 仓库</a> 下载 Flamegraph 工具包。可以使用以下命令克隆仓库：</p>
<div class="fragment"><div class="line">git clone https://github.com/brendangregg/Flamegraph.git</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md21"></a>
2. 记录性能数据</h3>
<p>首先，需要使用 <code>perf</code> 或其他工具（如 <code>dtrace</code>、<code>systemtap</code> 等）来收集性能数据。例如，使用 <code>perf</code> 记录数据：</p>
<div class="fragment"><div class="line">perf record -g ./your_program</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md22"></a>
3. 导出性能数据为火焰图格式</h3>
<p>使用 <code>perf script</code> 命令将性能数据导出为可用于生成火焰图的格式：</p>
<div class="fragment"><div class="line">perf script &gt; out.perf</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md23"></a>
4. 生成火焰图</h3>
<p>在 Flamegraph 工具包目录中，你可以使用以下命令生成火焰图：</p>
<div class="fragment"><div class="line">./stackcollapse-perf.pl out.perf &gt; out.folded</div>
<div class="line">./flamegraph.pl out.folded &gt; flamegraph.svg</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md24"></a>
5. 查看火焰图</h3>
<p>打开生成的 <code>flamegraph.svg</code> 文件，你可以使用浏览器查看火焰图。火焰图的宽度表示函数调用的时间花费，较宽的部分表示较高的 CPU 占用。</p>
<p>在火焰图中，函数调用以堆叠的方式显示，您可以通过放大和点击不同的函数来获得更多信息。识别出长时间运行的函数或频繁调用的函数，以找出潜在的性能瓶颈。</p>
<h3><a class="anchor" id="autotoc_md25"></a>
额外的工具和选项</h3>
<ul>
<li>**其他数据来源**：Flamegraph 工具包支持来自不同源的性能数据，包括 <code>dtrace</code> 和 <code>systemtap</code>。</li>
<li>**不同的输出格式**：Flamegraph 也支持其他输出格式，如 SVG、PNG 和 PDF。</li>
</ul>
<p>确保根据你的具体需求和环境配置相应的命令和参数。如果你需要更多详细的帮助，Flamegraph 的 GitHub 页面也提供了文档和示例。</p>
<h2><a class="anchor" id="autotoc_md26"></a>
6. 分析结果</h2>
<p>根据 <code>perf report</code> 输出的信息，分析哪些函数占用了较多的时间，并尝试优化相关代码。</p>
<p>通过以上步骤，你就可以使用 <code>perf</code> 工具进行程序性能分析，并获取详细的性能数据。</p>
<p><code>perf</code> 提供了许多其他选项，你可以通过 <code>perf --help</code> 查看所有可用命令和选项。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.0 </li>
  </ul>
</div>
</body>
</html>
